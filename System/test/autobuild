#!/bin/sh
# $Id: autobuild,v 1.4 2002-10-28 05:23:24 wedgingt Exp $
#
# Automatically build some variants of the Europa planner system

# Don't try to use X11 (mostly to prevent Purify from doing so)
DISPLAY=
export DISPLAY

# Apply limits; some compiles run out of swap space.
ulimit -c 200000
ulimit -d 1100000
ulimit -s 1100000
ulimit -v 1100000

# Print the limits so it is obvious what they are when something goes
# wrong.
ulimit -a

# Sometimes, this is run via cron, which does not use the usual $PATH
PATH=/usr/local/bin:/usr/local/teTeX/bin:"$PATH"
export PATH

CVSROOT=/home/cvs/ISG-Repository
export CVSROOT

set -x

startdir="`dirname $0`"
startdir="`cd $startdir; pwd`"

echo cd "$startdir"
cd "$startdir"

trap 'rmdir $startdir/working $startdir/restart $startdir/resubmit' 0

# Don't run this script more than once in the same directory.
mkdir working || exit 1

# Create this directory during a run to have this script restart via at.
mkdir restart || exit 1

# Create this directory during a run to stop before the long tests and restart via at.
mkdir resubmit || exit 1

rmdir restart resubmit || exit 2

subdirs=cvs

# Primary compilation loop
for dir in $subdirs
do

    cd "$startdir"
    test ! -d restart || break
    if test -d "$dir"/NewPlan
    then
        echo "$0"': '"$dir"'/NewPlan already exists; exiting'
        exit 1
    fi

    if test ! -d "$dir"
    then
        mkdir "$dir"
        test $? = 0 || exit $?
    fi

    cd "$dir"

    cvs co NewPlan

    cd NewPlan

    mkdir working || continue

    # Edit commonMakeOptions.imake via some config file in ..

    test -d "$startdir"/working || exit 2
    test ! -d "$startdir"/restart || break

    make $makeopt tests >> make.tests 2>&1
    status=$?
    echo '"make tests" in '"`pwd`"' exited '"$status"

    test $status = 0 || mkdir working/failed

    rmdir working || exit 1

    # Now, wipe out all that hard work
    cd "$startdir"/"$dir"

    rm -rf NewPlan

done

test -d resubmit -a ! -d restart && mv resubmit restart

cd "$startdir"
test ! -d restart -a ! -d resubmit && exit 0

echo "echo 'Europa autobuild failed: at read commands from stdin despite -f flag'" | at -q b -s -f autobuild
