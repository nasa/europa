#!/bin/sh
# $Id: autobuild,v 1.65 2004-05-20 06:09:33 wedgingt Exp $
#
# Automatically build some variants of the Europa planner system

set -x

# Usually, this is run via cron, which does not use the usual $PATH
PATH=/usr/local/bin:"$PATH"
export PATH

startdir="`dirname $0`"
startdir="`cd $startdir; pwd`"
cd "$startdir"

# Don't run this script more than once in the same directory.
mkdir working || exit 1

trap 'rmdir $startdir/working; rm -f $startdir/.tokens.$$' 0

# Address to mail exit status messages to
email=checkins@postdoc.arc.nasa.gov

# Subdirectories to build in
# Profiling and shared in one executable no longer works, it seems
#subdirs='cvs fast opt optFast profOptFast shareOptFast debug debugOpt noErr shareOptNoErr'
subdirs='cvs opt optFast profOptFast shareOptFast debugOpt'

if test -z "$EUROPA_CNET_INCR_REPROP" -o 0"$EUROPA_CNET_INCR_REPROP" = 00
then
    echo Full repropagation will be used.
else
    echo Incremental repropagation will be used.
fi

# CVS info
CVS_RSH=ssh
export CVS_RSH
CVSROOT='copernicus.arc.nasa.gov:/home/cvs/ISG-Repository'
export CVSROOT

# Don't try to use X11 (mostly to prevent Purify from doing so)
DISPLAY=
export DISPLAY

# Make sure that libstdc++.so is in this
LD_LIBRARY_PATH='/usr/lib'
export LD_LIBRARY_PATH

# Debug memory allocation; one variant fails in allocation presently here on Slayton
MALLOC_CHECK_=2
export MALLOC_CHECK_

# Apply limits; some compiles run out of swap space.
ulimit -c 300000
ulimit -d 2000000
ulimit -s 2000000
ulimit -v 2000000

# Print the limits so it is obvious what they are when something goes wrong.
ulimit -a

# Primary compilation loop
for dir in $subdirs
do

    cd "$startdir"

    if test ! -d "$dir"
    then
        mkdir "$dir"
        test $? = 0 || exit $?
    fi

    cd "$dir"

    if test -d NewPlan
    then
	mkdir NewPlan/working || exit 2
	mkdir NewPlan/working/rerun || exit 2
    else
	cvs co NewPlan > cvs.co.NewPlan 2>&1
	status=$?
	echo '"cvs co NewPlan" in '"`pwd`"' exited '"$status"
	mkdir NewPlan/working || exit 2
	if test "$status" != 0
	then
	    mkdir NewPlan/working/cvs.co.failed
	    exit "$status"
	fi
	if test -f make.options
	then
            # Add to commonMakeOptions.imake
	    head -2 NewPlan/commonMakeOptions.imake > cMO.new
	    cat make.options >> cMO.new
	    echo '' >> cMO.new
	    tail +3 NewPlan/commonMakeOptions.imake >> cMO.new
	    mv -f cMO.new NewPlan/commonMakeOptions.imake
	fi
    fi

    cd NewPlan

    test -d "$startdir"/working || exit 2

    make $makeopt EuropaDist.tar >> make.tests 2>&1
    statusMakeTar=$?
    echo '"make '"$makeopt"' EuropaDist.tar" in '"`pwd`"' exited '"$statusMakeTar"

    if test $statusMakeTar = 0
    then
        make $makeopt plannerTests unofficial timings >> make.tests 2>&1
        status=$?
        echo '"make '"$makeopt"' plannerTests unofficial timings" in '"`pwd`"' exited '"$status"

        if test $status = 0
        then
            mkdir ../testDist && cd ../testDist && tar -xpf ../NewPlan/EuropaDist.tar
            statusTarExtract=$?
            echo '"tar -xpf EuropaDist.tar" in '"`pwd`"' exited '"$statusTarExtract"

            if test $statusTarExtract = 0
            then
                make $makeopt simple >> make.simple 2>&1
                statusMakeDist=$?
                echo '"make '"$makeopt"' simple" in '"`pwd`"' exited '"$statusMakeDist"

                if test $statusMakeDist = 0
                then
                    make $makeopt clean >> make.simple.clean 2>&1
                    statusMakeDistClean=$?
                    echo '"make '"$makeopt"' clean" in '"`pwd`"' exited '"$statusMakeDistClean"

                    if test $statusMakeDistClean = 0
                    then
                        cd ../NewPlan
                        make $makeopt clean >> make.clean 2>&1
                        statusMakeClean=$?
                        echo '"make '"$makeopt"' clean" in '"`pwd`"' exited '"$statusMakeClean"
                        cd ..
                    fi
                fi
            fi
        fi
    fi

    if test $statusMakeTar$status$statusTarExtract$statusMakeDist$statusMakeDistClean$statusMakeClean = 000000
    then
        (uname -a; echo ''; cat make.options; echo ''; g++ --version; echo ''; cat NewPlan/SupportFiles/timings) | \
            Mail -s 'Autobuild on '"`hostname`"' in '"`pwd`"' succeeded' "$email"

        # If appropriate, look for and save the profiling data
        if egrep PROFILE make.options > /dev/null 2>&1
        then
            find "$HOME"/europa.profiles -type d -mtime +7 -ls > .autobuild.profFind
            if test -s .autobuild.profFind
            then
                NewPlan/SupportFiles/gather.gprofs
		cvs tag -F Europa-Auto-Profiled-"`uname -n | sed -e 's/[.].*$//'`"
            fi
            rm -rf .autobuild.profFind
        fi
    else
        ( uname -a; echo ''; cat make.options; echo ''; g++ --version; echo ''; tail -40 NewPlan/make.tests) | \
            Mail -s 'Autobuild in '"`pwd`"' failed; exited '"$status" "$email"
        mkdir NewPlan/working/failed
    fi

    # Save the make output files and the timings data
    mv NewPlan/make.tests . || exit 2
    mv testDist/make.simple . || exit 2
    mv testDist/make.simple.clean . || exit 2
    mv NewPlan/make.clean . || exit 2
    mv NewPlan/SupportFiles/timings* . || exit 2

    # Would continue with the next one after a failure,
    #   but the disk space might not be available.
    rmdir NewPlan/working || exit 1

    # Now, wipe out all that hard work
    rm -rf NewPlan testDist

done
exit 0
