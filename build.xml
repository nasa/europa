<?xml version="1.0" encoding="UTF-8"?>
<project name="PLASMA" default="build" basedir=".">

  <description>PLASMA</description>

  <taskdef resource="net/sf/antcontrib/antcontrib.properties">
    <classpath>
      <pathelement location="ext/ant/lib/ant-contrib-1.0b3.jar"/>
    </classpath>
  </taskdef>
  <target name="init" depends="findSystem">
    <property environment="env"/>

    <property name="europa.version" value="2.4"/> 	

    <!-- load local overrides -->
    <property file="${user.home}/.ant.plasma.properties"/>
		
    <if>
    	<equals arg1="${jam.variant}" arg2="OPTIMIZED"/>
    	<then>
    	    <property name="run-example-cpp.mode" value="FAST=1"/>	
            <property name="run-example-java.mode" value="o"/>     
    	</then>
    	<else>
            <property name="run-example-cpp.mode" value=""/>      
            <property name="run-example-java.mode" value="g"/>     
    	</else>
    </if>	
  	
	<if>
	  <contains string="${ver}" substring="Windows" casesensitive="false"/>
	    <then>
			<property name="local.os" value="WindowsVS"/>
		</then>
	</if>

    <if>
      <or>
        <contains string="${uname.s}" substring="Linux" casesensitive="false"/>
      </or>
      <then>
      	<property name="local.os" value="linux"/>
      </then>
      <!-- Mac OS X -->
      <elseif>
        <contains string="${uname.s}" substring="Darwin" casesensitive="false"/>
        <then>
          <property name="local.os" value="darwin"/>
          <property name="local.env.LD_LIBRARY_PATH.name" value="DYLD_LIBRARY_PATH"/>
        </then>
      </elseif>

      <elseif>
        <contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>
	<then>
	<!-- Windows-MinGW running inside cygwin -->
        <if>
	  <contains string="${gcc.location}" substring="mingw" casesensitive="false"/>
	  <then>
	    <property name="local.os" value="MinGW"/>
	    <exec executable="cygpath" outputproperty="local.env.PLASMA_HOME">
	      <arg value="--mixed"/>
              <!--<arg value="-absolute"/>-->
              <arg value="${basedir}"/>
            </exec>

	    <exec executable="cygpath" outputproperty="local.env.EUROPA_HOME">
	      <arg value="--mixed"/>
	      <!--<arg value="-absolute"/>-->
	      <arg value="${basedir}/dist/europa"/>
	    </exec>
	    <exec executable="cygpath" outputproperty="local.env.CYG_JAVA_HOME">
              <arg value="--mixed"/>
              <arg value="--absolute"/>
              <arg value="${env.JAVA_HOME}"/>
	    </exec>
            <property name="jam.libraries" value="STATIC"/>
	    <property name="jam.misc" value="-sOS=CYGWIN" />
	  </then>
	  <else>
	    <!-- Windows-Cygwin -->
	    <property name="local.os" value="windows"/>
	    <exec executable="cygpath" outputproperty="local.env.PLASMA_HOME">
              <arg value="--unix"/>
              <!--<arg value="-absolute"/>-->
              <arg value="${basedir}"/>
            </exec>
            <exec executable="cygpath" outputproperty="local.env.EUROPA_HOME">
              <arg value="--unix"/>
              <!--<arg value="-absolute"/>-->
              <arg value="${basedir}/dist/europa"/>
            </exec>
            <exec executable="cygpath" outputproperty="local.env.CYG_JAVA_HOME">
              <arg value="--unix"/>
              <arg value="--absolute"/>
              <arg value="${env.JAVA_HOME}"/>
            </exec>
            <property name="jam.libraries" value="STATIC"/>
            <property name="jam.misc" value="-sOS=CYGWIN"/>
	  </else>
	</if>  
        </then>
      </elseif>
    	
      <!-- Solaris -->
      <elseif>
        <contains string="${uname.s}" substring="SunOS" casesensitive="false"/>
        <then>
          <property name="local.os" value="solaris"/>
      	</then>
      </elseif>
    </if>
    <echo message="Running as a ${local.os} build."/>
  	
    <if>
      <contains string="${uname.a}" substring="x86_64" casesensitive="false"/>
      <then>
          <property name="jam.64bit" value="-s64BIT=1"/>
     </then>
    </if>

    <if>
      <equals arg1="${jam.64bit}" arg2="-s64BIT=1"/>
      <then>
        <property name="jam.march" value="-m64"/>
      </then>
      <else>
        <property name="jam.march" value="-m32"/>
      </else>
    </if>


    <property name="local.env.PLASMA_HOME" value="${basedir}"/>
    <property name="local.env.EUROPA_HOME" value="${local.env.PLASMA_HOME}/dist/europa"/>
    <if>
      <contains string="${uname.s}" substring="SunOS" casesensitive="false"/>
      <then>
        <condition property="local.env.LD_LIBRARY_PATH.value"
                   value="${antlr.lib}:${local.env.PLASMA_HOME}/build/lib:${env.LD_LIBRARY_PATH}"
                   else="${local.env.PLASMA_HOME}/build/lib:${env.LD_LIBRARY_PATH}">
          <isset property="antlr.lib"/>
        </condition>
      </then>
      <else>
        <condition property="local.env.LD_LIBRARY_PATH.value"
                   value="${antlr.lib}:${local.env.PLASMA_HOME}/build/lib"
                   else="${local.env.PLASMA_HOME}/build/lib">
          <isset property="antlr.lib"/>
        </condition>
      </else>
    </if>

    <if>
      <isset property="antlr.include"/>
      <then>
        <property name="jam.antlr.include" value="-I${antlr.include}"/>
      </then>
    </if>
    <if>
      <isset property="antlr.lib"/>
      <then>
        <property name="jam.antlr.lib" value="-Wl,-L${antlr.lib}"/>
      </then>
    </if>
      
    <property name="local.env.LD_LIBRARY_PATH.name" value="LD_LIBRARY_PATH"/>
    <property name="dir.plasma" value="${basedir}"/>
    <property name="dir.src" value="src/PLASMA"/>
    <condition property="dir.planworks" value="${env.PLANWORKS_HOME}">
      <isset property="${env.PLANWORKS_HOME}"/>
    </condition>
    <property name="dir.planworks" value="${basedir}/../PlanWorks"/>
    <available property="planworks.present" file="${dir.planworks}"/>
    <condition property="jam.num.cores" value="${env.PLASMA_NUM_CORES}">
      <isset property="${env.PLASMA_NUM_CORES}"/>
    </condition>
    <property name="jam.num.cores" value="1"/>
    <property name="dir.build" value="build"/>
    <property name="dir.dist" value="dist"/>
    <property name="dir.dist.base" location="${dir.dist}/europa"/>
    <property name="file.europa-dist" value="europa-${europa.version}-${local.os}.zip"/>
    <property name="file.europa-static-libs" value="europa-${europa.version}-${local.os}-static-libs.zip"/>	
	<if>      
      <contains string="${ver}" substring="Windows" casesensitive="false"/>
      <then>
        <condition property="msbuild.dir"
                   value="${msbuild.dir}"
                   else="C:\\Windows\\Microsoft.NET\\Framework\\v3.5\\">
          <isset property="msbuild.dir"/>
        </condition>
      </then>
    </if>	
    <property name="jam.exec" value="jam"/>
    <property name="jam.libraries" value="SHARED"/>
    <property name="jam.variant" value="DEV"/>
    <property name="jam.log.type" value=""/>  <!-- choices are USE_EUROPA_LOGGER, ALL_LOGGING_DISABLED, "" -->
    <property name="jam.misc" value=""/>
    <property name="jam.args" value=""/>
    <property name="jam.64bit" value=""/>
    <property name="jam.antlr.include" value=""/>
    <property name="jam.antlr.lib" value=""/>
    <property name="jam.platform-flags" value="${jam.antlr.include} ${jam.march}"/>
    <property name="jam.link-libs" value="${jam.antlr.lib}"/>

    <property name="jam.opts" value="${jam.args} ${jam.misc} ${jam.64bit} -sLOGGER_TYPE=${jam.log.type} -sVARIANTS=${jam.variant} -sLIBRARIES=${jam.libraries} -sPLATFORM_FLAGS=&quot;${jam.platform-flags}&quot; -sLINKLIBS=&quot;${jam.link-libs}&quot;"/>
    <if>
      <equals arg1="${jam.log.type}" arg2=""/>
      <then>
	<property name="make.log.type" value=""/> 
      </then>
      <else>
	<property name="make.log.type" value="LOGGER_TYPE=-D${jam.log.type}"/> 
      </else>
    </if>
  </target> <!-- init -->

	<target name="findSystem">
		<if>		
		  <contains string="${os.name}" substring="Windows" casesensitive="false"/>  <!-- Assume nobody uses Cygwin -->
          <then>
		    <property name="local.os" value="WindowsVS"/>
			<property name="ver" value="WindowsVS"/>
      	  </then>
		<else>
			<exec executable="uname" outputproperty="uname.s">
			  <arg value="-s"/>
			</exec>
			<exec executable="uname" outputproperty="uname.a">
			  <arg value="-a"/>
			</exec>	
			<exec executable="which" outputproperty="gcc.location">
			  <arg value="gcc"/>
			</exec>
		</else>
		</if>
	</target>  
  
  <target name="print-env" depends="init" 
      description="Debug target: Prints the initialized environment" >
	  <if>
		<contains string="${ver}" substring="Windows" casesensitive="false"/>  <!-- Assume nobody uses Cygwin -->
		<then>
			<exec executable="cmd"> 
				<arg line="/c set"/>
			</exec>
		</then>
		<else>
		<exec executable="env"/> 
		</else>
		</if>
  </target>

  <target name="test-ant" depends="init,print-env" 
      description="Debug target: Tests that this build file can call 'ant' as an executable.">
    <echo message="testing ant exec"/>
    <if>
	  <or>
      <contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>	  
	  <contains string="${ver}" substring="Windows" casesensitive="false"/>
	  </or>
      <then>
        <exec executable="cmd" dir="c:\" failonerror="true">
          <arg value="/c"/>
          <arg value="${env.ANT_HOME}/bin/ant.bat"/>
          <arg value="-Dproject.bsh.script=Batch.bsh"/>
          <arg value="-Dproject.mode=${run-example-java.mode}"/>
          <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
          <env key="PATH" value=""/>
          <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.EUROPA_HOME}/lib"/>
        </exec>
      </then>
      <else>
        <exec executable="ant" dir="\" failonerror="true">
          <arg line="-Dproject.bsh.script=Batch.bsh -Dproject.mode=${run-example-java.mode}"/>
          <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
          <env key="PATH" value=""/>
          <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.EUROPA_HOME}/lib"/>
        </exec>
      </else>
    </if>
  </target>

  <target name="clean" depends="init">
	<delete dir="${dir.dist}"/>
	<if>		
		<contains string="${ver}" substring="Windows" casesensitive="false"/>
		<then>
			<exec executable="${msbuild.dir}\\MSBuild.exe" failonerror="true">
			  <arg line="/target:clean /p:Platform=Win32 /p:Configuration=Debug Europa.sln"/>
			</exec>
		</then>
		<else>			  
				<exec executable="${jam.exec}" dir="${dir.src}" failonerror="true">
				  <arg line="clean-all"/>
				  <env key="PLASMA_HOME" value="${local.env.PLASMA_HOME}"/>
				</exec>				
		</else>
	</if>
	<ant dir="src/JavaUI" description="Clean up Java part" target="clean.all" />
		<delete dir="${dir.build}"/>
  </target>

  <target name="build" depends="init">
  <echo>${ver}</echo>
  <if>		
		<contains string="${ver}" substring="WindowsVS" casesensitive="false"/>
		<then>
			<echo message="Building System dlls for Windows."/>	
				<exec executable="${msbuild.dir}\\MSBuild.exe" failonerror="true">
					<arg line="/target:build /p:Platform=Win32 /p:Configuration=Debug EuropaBaseSystem.sln"/>
					<env key="PLASMA_HOME" value="${basedir}"/>
					<env key="EUROPA_HOME" value="${basedir}\dist\europa"/>					
				</exec>				
				
			<if>
			  <equals arg1="${build.libraries}" arg2="STATIC"/>
			  <then>
				<exec executable="${msbuild.dir}\\MSBuild.exe" failonerror="true">
					<arg line="/target:build /p:Platform=Win32 /p:Configuration=Debug src\PLASMA\EuropaFullSystemStatic.sln"/>
					<env key="PLASMA_HOME" value="${basedir}"/>
					<env key="EUROPA_HOME" value="${basedir}\dist\europa"/>
				</exec>
			  </then>
			  <else>
				<exec executable="${msbuild.dir}\\MSBuild.exe" failonerror="true">
					<arg line="/target:build /p:Platform=Win32 /p:Configuration=Debug EuropaDll.sln"/>
					<env key="PLASMA_HOME" value="${basedir}"/>
					<env key="EUROPA_HOME" value="${basedir}\dist\europa"/>
				</exec>
			  </else>
			</if>			
<!--			
				<delete file="src\\JavaUI\\lib\\PSEngine.jar"/>				
				<exec executable="mklink" dir="src\\JavaUI\\lib" failonerror="true">
					<arg line="PSEngine.jar ..\..\Europa\build\lib\PSEngine.jar"/>
				</exec>				
				<ant dir="src/JavaUI" description="Build Swing version of Java UI" target="build.swing">
					<property name="europa.dir" value="${local.env.PLASMA_HOME}" />
					<property name="psengine.jar.path" value="${local.env.PLASMA_HOME}/build/lib" />
				</ant>
-->				
		</then>
		<else>
				<echo message="jam ${jam.opts} -j${jam.num.cores} build"/>
				<exec executable="${jam.exec}" dir="${dir.src}" failonerror="true">
				  <arg line="${jam.opts} -j${jam.num.cores} build"/>
				  <env key="PLASMA_HOME" value="${local.env.PLASMA_HOME}"/>
				  <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.LD_LIBRARY_PATH.value}"/>
				  <!-- This is set only for Windows, but other OSs don't care anyway -->
				  <env key="CYG_JAVA_HOME" value="${local.env.CYG_JAVA_HOME}" />
				</exec>
				
				<if>
				  <contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>
				  <then>
					<echo message="Building System dlls for Windows."/>
					<if>
					  <equals arg1="${jam.variant}" arg2="OPTIMIZED"/>
					  <then>
						<property name="s" value="_o"/>
					  </then>
					</if>
					<property name="s" value="_g"/>
					<echo message="Suffix ${s}" />
					
					<!-- libANML_?.a disappeared? -mno-cygwin libAntlr3${s}.a -->
					<property name="cmd" value="g++ -shared 
						-Wl,-v
					-oSystem${s}.dll 
						-Wl,--add-stdcall-alias 
					-Wl,--output-def=System${s}.dll.def
					-Wl,--out-implib=System${s}.a
					-Wl,--whole-archive libSystem${s}.a libSolvers${s}.a libResource${s}.a libNDDL${s}.a 
										libRulesEngine${s}.a libTemporalNetwork${s}.a libPlanDatabase${s}.a 
											libConstraintEngine${s}.a libUtils${s}.a libTinyXml${s}.a  -lws2_32
						-Wl,--no-whole-archive -lpthread -lantlr3c
					"/>
					<exec executable="bash" dir="${dir.plasma}/build/lib">
					  <arg value="-c" />
					  <arg value="${cmd}" />
					</exec>
				  </then>
				</if>
				<ant dir="src/JavaUI" description="Build Swing version of Java UI" target="build.swing">
					<property name="europa.dir" value="${local.env.PLASMA_HOME}" />
					<property name="psengine.jar.path" value="${local.env.PLASMA_HOME}/build/lib" />
				</ant>			
		</else>
	</if>									
  </target>

  <target name="jam-target" depends="init">
    <echo message="jam ${jam.opts} ${jam.target}"/>
    <exec executable="${jam.exec}" dir="${dir.src}" failonerror="true">
      <arg line="${jam.opts} ${jam.target}"/>
      <env key="PLASMA_HOME" value="${local.env.PLASMA_HOME}"/>
      <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.LD_LIBRARY_PATH.value}"/>
      <!-- This is set only for Windows, but other OS don't care anyway -->
      <env key="CYG_JAVA_HOME" value="${local.env.CYG_JAVA_HOME}" />
    </exec>
  </target>

  <target name="test" depends="build, print-env">
	<if>
		<contains string="${ver}" substring="Windows" casesensitive="false"/>
		<then>
			<exec executable="${msbuild.dir}\\MSBuild.exe" failonerror="true">
			  <arg line="/target:test /p:Platform=Win32 /p:Configuration=Debug examples\VS_Examples\Test.sln"/>
			  <env key="PLASMA_HOME" value="${basedir}"/>
				<env key="EUROPA_HOME" value="${basedir}\dist\europa"/>
			</exec>			
			<condition property="test.exists">
				<available file="Test.exe" filepath="${basedir}\\build\\lib\\Debug"/>
			</condition>			
			<condition property="pthreads.exists">
				<available file="${env.PLASMA_THIRD_PARTY}\visualStudio\pthreads-w32-2-8-0-release\lib" filepath="${env.PLASMA_THIRD_PARTY}\visualStudio\pthreads-w32-2-8-0-release\lib"/>
			</condition>	
			<property name="local.env.PATH.name" value="Path"/>
			<property name="local.env.PATH.value" value="${basedir}\build\lib\Debug;${basedir}\dist\europa\build\lib\Debug;${env.PLASMA_THIRD_PARTY}\visualStudio\pthreads-w32-2-8-0-release\lib;${basedir}\dist\europa\lib\Debug;"/>			
			<!--
			<echo>test found: ${test.exists}</echo>
			<echo>pthreads found: ${pthreads.exists}</echo>
			<echo>Path=${env.Path}</echo>
			<echo>${local.env.PATH.name}=${local.env.PATH.value}</echo>
			<echo>PLASMA_HOME=${local.env.PLASMA_HOME}</echo>
			<echo>PLASMA_THIRD_PARTY=${env.PLASMA_THIRD_PARTY}</echo>			
			<echo>Local.Path=${local.env.PATH.value}</echo>
			-->
			<property name="test.dir" value="${env.PLASMA_HOME}\\build\\lib\\Debug"/>								
				<exec executable="${basedir}\\build\\lib\\Debug\\Test" dir="examples\\VS_Examples" failonerror="true" searchpath="true">					
					<arg line="Light-initial-state.nddl PlannerConfig.xml"/>				
					<env key="PLASMA_HOME" value="${basedir}"/>
					<env key="EUROPA_HOME" value="${basedir}\dist\europa"/>
					<env key="PATH" path="${env.path}:${env.Path}:${local.env.PATH.value}"/>
				</exec>
		</then>
		<else>
			<exec executable="${jam.exec}" dir="${dir.src}" failonerror="true">
			  <arg line="${jam.opts} run-all-tests"/>
			  <env key="PLASMA_HOME" value="${local.env.PLASMA_HOME}"/>
			  <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.LD_LIBRARY_PATH.value}"/>
			</exec>
		</else>
	</if>
  </target>

  <!-- This target assumes that PLASMA and PlanWorks have already been built so that all the products are in place -->
  <target name="dist" depends="init" 
          description="Creates the binary distribution and packages it up into ${dir.dist}/${file.plasma_dist}">
   <!-- Create the distribution directory  -->
    <mkdir dir="${dir.dist}"/>
    <mkdir dir="${dir.dist.base}/bin"/>

    <copy todir="${dir.dist.base}/bin">
      <!-- TODO: copy script to run PSDesktop -->
      <fileset dir="${dir.plasma}/bin"/>
    </copy>
    <copy todir="${dir.dist.base}/lib">
      <fileset dir="${dir.plasma}/build/lib"/>	  
    </copy>
	
	<if>		
		<contains string="${ver}" substring="WindowsVS" casesensitive="false"/>
		<then>
		<copy todir="${dir.dist.base}/lib/Debug">
			<fileset dir="${env.PLASMA_THIRD_PARTY}\visualStudio\pthreads-w32-2-8-0-release\lib"/>	  
		</copy>
		</then>
	</if>

    <copy todir="${dir.dist.base}/examples">
      <fileset dir="${dir.plasma}/examples"/>
    </copy>

    <copy todir="${dir.dist.base}/include" flatten="true" includeEmptyDirs="false">
      <fileset file="${dir.src}">
        <include name="**/PS*.hh"/>
        <exclude name="**/PS*Impl.hh"/>
      </fileset>
      <fileset dir="${dir.src}/NDDL/base">
        <include name="*.nddl"/>
      </fileset>
      <fileset dir="${dir.src}/Resource/component/NDDL">
        <include name="*.nddl"/>
      </fileset>
    </copy>
    <copy todir="${dir.dist.base}/include/jam" flatten="true" includeEmptyDirs="false">
      <fileset file="${dir.src}">
        <include name="**/*Rules"/>
      </fileset>
    </copy>
    <copy todir="${dir.dist.base}/include/PLASMA" flatten="true">
      <fileset dir="${dir.src}">
        <include name="**/*.hh"/>
        <include name="**/*.h"/>
        <exclude name="**/test/**"/>
      </fileset>
    </copy>
    <!-- <copy todir="${dir.dist.base}/include" flatten="false">
      <fileset dir="${dir.src}/Log4cpp/log4cpp-1.0.patch1/include">
        <include name="**/*.hh"/>
        <include name="**/*.h"/>
      </fileset>
    </copy> -->

    <if>
      <isset property="antlr.include"/>
      <then>
        <copy todir="${dir.dist.base}/include" flatten="false">
          <fileset dir="${antlr.include}">
            <include name="antlr3*.h"/>
          </fileset>
        </copy>
      </then>
    </if>

    <if>
      <isset property="antlr.lib"/>
      <then>
        <copy todir="${dir.dist.base}/lib" flatten="false">
          <fileset dir="${antlr.lib}">
            <include name="libantlr3c.*"/>
          </fileset>
        </copy>
      </then>
    </if>

    <copy todir="${dir.dist.base}/config">
      <fileset dir="${dir.plasma}/config"/>
    </copy>

    <!-- if PlanWorks is present, copy it into the distribution -->
    <if>
      <isset property="planworks.present"/>
      <then>
        <copy todir="${dir.dist.base}/bin">
          <fileset file="${dir.planworks}/bin/PlanWorks.sh"/>
        </copy>

        <copy todir="${dir.dist.base}/lib">
          <fileset dir="${dir.planworks}/build/lib"/>
        </copy>

        <copy todir="${dir.dist.base}/config">
          <fileset dir="${dir.planworks}/config"/>
        </copy>

        <copy todir="${dir.dist.base}/res">
          <fileset dir="${dir.planworks}/res"/>
        </copy>
      </then>
    </if>

    <!-- ant doesn't preserve permissions -->
    <chmod perm="+x">
      <fileset dir="${dir.dist.base}/bin"/>
    </chmod>
  </target>

  <target name="zip-dist" depends="dist"
        description="Puts distribution in a single zip file, excludes static libs">
    <delete file="${dir.dist}/${file.europa-dist}"/>
	<if>      
      <contains string="${ver}" substring="Windows" casesensitive="false"/>
      <then>
		<echo>Dynamic libraries called here</echo>
	</then>
	<else>
		<zip destfile="${dir.dist}/${file.europa-dist}">
			<zipfileset dir="${dir.dist.base}/bin" prefix="bin" dirmode="775" filemode="775"/>
			<zipfileset dir="${dir.dist.base}/config" prefix="config" dirmode="775" filemode="664"/>
			<zipfileset dir="${dir.dist.base}/examples" prefix="examples" dirmode="775" filemode="664"/>
			<zipfileset dir="${dir.dist.base}/include" prefix="include" dirmode="775" filemode="664"/>
			<zipfileset dir="${dir.dist.base}/lib"  excludes="*.a" prefix="lib" dirmode="775" filemode="664"/>
		</zip>
	</else>
	</if>
  </target>
		
  <target name="zip-static-libs" depends="dist"
  	description="create a zip file for static libs only">
    <delete file="${dir.dist}/${file.europa-static-libs}"/>
	<if>      
		<contains string="${ver}" substring="Windows" casesensitive="false"/>
		<then>
			<echo>${dir.dist.base}\lib</echo>
			<zip destfile="${dir.dist}/${file.europa-static-libs}">
				<zipfileset dir="${dir.dist.base}/lib" includes="*.lib" dirmode="775" filemode="664"/>
				<zipfileset dir="${dir.dist.base}/lib/Debug" includes="*.lib" dirmode="775" filemode="664"/>
			</zip>
		</then>
		<else>
			<zip destfile="${dir.dist}/${file.europa-static-libs}">
				<zipfileset dir="${dir.dist.base}/lib" includes="*.a" prefix="lib" dirmode="775" filemode="664"/>
			</zip>
		</else>
	</if>
  </target>
  
  <target name="run-diff" if="diff.allow">
    <echo> Running Diff example in ${basedir}/dist/europa/examples/${example.name}</echo>
    <exec executable="python" dir="${basedir}/dist/europa/bin"
    	output="${basedir}/dist/europa/examples/${example.name}/${example.name}.diff" failonerror="true">
      <arg line="plancompare ${example.name}"/>
      <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
    </exec>
  </target>
	                
  <target name="run-example-cpp">
    <echo> Running CPP example in ${basedir}/dist/europa/examples/${example.name}</echo>
    <echo>   on ${uname.s} platform. </echo>
    <if>
      <contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>
      <then>
        <echo> Fixing platforms.mk linkage problem on windows </echo>
        <exec executable="rm" dir="${basedir}/dist/europa/examples/${example.name}" failonerror="true">
          <arg value="platforms.mk.lnk"/>
        </exec>
        <exec executable="ln" dir="${basedir}/dist/europa/examples/${example.name}" failonerror="true">
          <arg value="-s"/>
          <arg value="../../bin/.makeproject/platforms.mk"/>
        </exec>
      </then>
    </if>
    <exec executable="make" dir="${basedir}/dist/europa/examples/${example.name}" failonerror="true">
      <arg line="${make.log.type}"/>
      <arg line="${run-example-cpp.mode}"/>
      <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
      <env key="${local.env.LD_LIBRARY_PATH.name}" value="${basedir}/dist/europa/lib"/>
    </exec>
    <condition property="diff.allow">
        <available file="${basedir}/dist/europa/examples/${example.name}/RUN_${example.name}-planner_g_rt.${example.name}-initial-state.nddl.PlannerConfig.xml.output"/>
    </condition>
    <antcall target="run-diff"></antcall>    
  </target>
	
  <target name="run-example-java">
    <echo> Running Java example in ${basedir}/dist/europa/examples/${example.name}</echo>
    <if>
      <contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>
      <then>
        <exec executable="cmd" dir="${basedir}/dist/europa/examples/${example.name}" failonerror="true">
          <arg value="/c"/>
          <arg value="${env.ANT_HOME}/bin/ant.bat"/>
          <arg value="-Dproject.bsh.script=Batch.bsh"/>
          <arg value="-Dproject.mode=${run-example-java.mode}"/>
          <!-- <arg value="-v"/> -->
          <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
          <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.EUROPA_HOME}/lib"/>
        </exec>
      </then>
      <else>
        <exec executable="ant" dir="${basedir}/dist/europa/examples/${example.name}" failonerror="true">
          <arg value="-Dproject.bsh.script=Batch.bsh"/>
          <arg value="-Dproject.mode=${run-example-java.mode}"/>
          <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
          <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.EUROPA_HOME}/lib"/>
        </exec>
      </else>
    </if>
  </target>
	
  <target name="test-makeproject" depends="init"
  	  description="Tests makeproject script">
      <exec executable="python" dir="${basedir}/dist/europa/bin" failonerror="true">
          <arg line="makeproject MakeProjectTest ${basedir}/dist/europa"/>
      	  <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
      </exec>	 		  
      <if>
          <contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>
  	  <then>
              <exec executable="cygpath" outputproperty="testdist.europa.home.tmp">
	          <arg value="--windows"/>
		  <arg value="${local.env.EUROPA_HOME}"/>
	      </exec>
  	      <propertyregex property="testdist.europa.home" input="${testdist.europa.home.tmp}" regexp="\\" replace="/" global="true" />
          </then>
      </if>
      <property name="testdist.europa.home" value="${local.env.EUROPA_HOME}"/>
	  <if>		
		  <contains string="${os.name}" substring="Windows" casesensitive="false"/>  <!-- Assume nobody uses Cygwin -->
          <then>
			<echo>Test Distribution here</echo>
		  </then>
		  <else>
			  <exec executable="make" dir="${basedir}/dist/europa/MakeProjectTest" failonerror="true">
			  <arg line="${make.log.type}"/>
				  <arg line="${run-example-cpp.mode}"/>
				  <env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
				  <env key="EUROPA_JHOME" value="${testdist.europa.home}"/>
				  <env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.LD_LIBRARY_PATH.value}"/>
			  </exec>
			  <if>
				<contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>
				<then>
				  <exec executable="cmd" dir="${basedir}/dist/europa/MakeProjectTest" failonerror="true">
					<arg value="/c"/>
					<arg value="${env.ANT_HOME}/bin/ant.bat"/>
					<arg value="-Dproject.bsh.script=Batch.bsh"/>
					<arg value="-Dproject.mode=${run-example-java.mode}"/>
					<env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
					<env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.LD_LIBRARY_PATH.value}"/>
				  </exec>
				</then>
				<else>
				  <exec executable="ant" dir="${basedir}/dist/europa/MakeProjectTest" failonerror="true">
					<arg line="-Dproject.bsh.script=Batch.bsh -Dproject.mode=${run-example-java.mode}"/>
					<env key="EUROPA_HOME" value="${local.env.EUROPA_HOME}"/>
					<env key="${local.env.LD_LIBRARY_PATH.name}" value="${local.env.LD_LIBRARY_PATH.value}"/>
				  </exec>
				</else>
			  </if>
		  </else>
		</if>
      <delete dir="${basedir}/dist/europa/MakeProjectTest"/>
  </target>
	        
  <target name="test-dist" depends="init,dist,test-makeproject" 
	      description="Runs tests on release">
	<if>		
			<contains string="${os.name}" substring="Windows" casesensitive="false"/>  <!-- Assume nobody uses Cygwin -->
          <then>
		  <echo>example goes here!</echo>
		  </then>
		  <else>
			<antcall target="run-example-cpp"><param name="example.name" value="BlocksWorld"/></antcall>	
			<antcall target="run-example-cpp"><param name="example.name" value="Light"/></antcall>	
			<antcall target="run-example-cpp"><param name="example.name" value="Rover"/></antcall>	
			<antcall target="run-example-cpp"><param name="example.name" value="Shopping"/></antcall>        
			<antcall target="run-example-cpp"><param name="example.name" value="UBO"/></antcall>

			<antcall target="run-example-java"><param name="example.name" value="BlocksWorld"/></antcall>  
			<antcall target="run-example-java"><param name="example.name" value="Light"/></antcall>        
			<antcall target="run-example-java"><param name="example.name" value="NQueens"/></antcall>        
			<antcall target="run-example-java"><param name="example.name" value="Rover"/></antcall> 
			<antcall target="run-example-java"><param name="example.name" value="Shopping"/></antcall>        
			<antcall target="run-example-java"><param name="example.name" value="UBO"/></antcall>  
			
			<ant dir="src/JavaUI" description="Run model tests for Java UI" target="test">
			<property name="europa.dir" value="${local.env.PLASMA_HOME}" />
			<property name="europa.home" value="${local.env.EUROPA_HOME}" />
			<property name="ld.path.key" value="${local.env.LD_LIBRARY_PATH.name}" />
			<property name="ld.path.value" value="${local.env.LD_LIBRARY_PATH.value}"/>
			<property name="psengine.jar.path" value="${local.env.PLASMA_HOME}/build/lib" />
			</ant>	
			</else>
	</if>		

  </target>
  
  <target name="release-dist" depends="init"
  	description="Creates a binary distribution that includes all the variants">
    <if>
      <not>
        <contains string="${uname.s}" substring="Cygwin" casesensitive="false"/>
      </not>	   
      <then>
      	<antcall target="build" inheritAll="false"><param name="jam.variant" value="DEV"/><param name="jam.libraries" value="SHARED"/></antcall>
      	<antcall target="build" inheritAll="false"><param name="jam.variant" value="OPTIMIZED"/><param name="jam.libraries" value="SHARED"/></antcall>
      </then>
    </if>	
	<if>		
		  <contains string="${os.name}" substring="Windows" casesensitive="false"/>  <!-- Assume nobody uses Cygwin -->
          <then>
		  <antcall target="build" inheritAll="false"></antcall>
		  <antcall target="build" inheritAll="false"><param name="build.libraries" value="STATIC"/></antcall>
		  </then>
		  <else>
			<antcall target="build" inheritAll="false"><param name="jam.variant" value="DEV"/><param name="jam.libraries" value="STATIC"/></antcall>
			<antcall target="build" inheritAll="false"><param name="jam.variant" value="OPTIMIZED"/><param name="jam.libraries" value="STATIC"/></antcall>
			<antcall target="build" inheritAll="false"><param name="jam.variant" value="PROFILE"/><param name="jam.libraries" value="STATIC"/></antcall>
		  </else>
	</if>	  
    <antcall target="zip-dist"/>
    <antcall target="zip-static-libs"/>
  </target>

  <target name="tags" depends="init"
          description="create tags and ebrowse files">
    <delete file="${dir.src}/TAGS"/>
    <delete file="${dir.src}/BROWSE"/>

    <apply executable="etags" dir="${dir.src}" parallel="true" failonerror="true" >
      <arg value="--declarations"/>
      <arg value="-I"/>
      <arg value="--members"/>
      <fileset dir="${dir.src}">
        <include name="*/*.hh"/>
        <include name="*/*/*.hh"/>
        <include name="*/*/*/*.hh"/>
        <include name="*/*.h"/>
        <include name="*/*/*.h"/>
        <include name="*/*/*/*.h"/>
        <include name="*/*.cc"/>
        <include name="*/*/*.cc"/>
        <include name="*/*/*/*.cc"/>
        <include name="*/*.cpp"/>
        <include name="*/*/*.cpp"/>
        <include name="*/*/*/*.cpp"/>
      </fileset>
    </apply>

    <apply executable="ebrowse" dir="${dir.src}" parallel="true" failonerror="true" >
      <fileset dir="${dir.src}">
        <include name="*/*.hh"/>
        <include name="*/*/*.hh"/>
        <include name="*/*/*/*.hh"/>
        <include name="*/*.h"/>
        <include name="*/*/*.h"/>
        <include name="*/*/*/*.h"/>
        <include name="*/*.cc"/>
        <include name="*/*/*.cc"/>
        <include name="*/*/*/*.cc"/>
        <include name="*/*.cpp"/>
        <include name="*/*/*.cpp"/>
        <include name="*/*/*/*.cpp"/>
      </fileset>
    </apply>
  </target>
    
  <!-- This will run the DEV variant by default, 
       if you want other variant, you can do it specifying jam.variant on the command line,
       for instance:
       ant -Djam.variant=OPTIMIZED autobuild
       or
       ant -Djam.variant=PROFILE -Djam.libraries=STATIC autobuild
  -->   
  <target name="autobuild"
          description="This target replicates what autobuild does for local testing">
      <antcall target="build"/>
      <antcall target="test"/>
      <if>
          <not><equals arg1="${jam.variant}" arg2="PROFILE"/></not>
          <then>      
              <antcall target="build"><param name="jam.libraries" value="STATIC"/></antcall>
              <antcall target="test"><param name="jam.libraries" value="STATIC"/></antcall>
              <antcall target="dist"/>
              <antcall target="test-dist"/>
          </then>
      </if>    
  </target>  

</project>
