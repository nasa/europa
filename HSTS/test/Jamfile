SubDir PLASMA HSTS test ;

if ! $(PLASMA_READY) {

#
# Heuristics Tests
#

HSTS_Test_Files = [ FGristFiles AtSubgoalRule HSTSModuleTests DNPConstraints ] ;
ModuleObjects $(HSTS_Test_Files:S=.cc) : HSTS ;

CET_Files = <ConstraintEngine!test>ConstraintTesting ;

# ConstraintTesting.hh is in ConstraintEngine/test, not here.
# !!This doesn't work, however, so I've changed the source to '#include "test/ConstraintingTest.hh"' to see if that works.
# INCLUDES on module-tests.cc += [ FDirName $($(_top)) ConstraintEngine test ] ;

ModuleMain hsts-module-tests : $(HSTS_Test_Files:S=$(SUFOBJ)) $(CET_Files:S=$(SUFOBJ)) module-tests.cc : HSTS : CBPlanner ;
RunModuleMain run-hsts-module-tests : hsts-module-tests ;

# Commented out tests are failing for various reasons; see each test for more info.
LocalDepends tests : run-hsts-module-tests
        monkey-timeline monkey-timeline-hacked monkey-timeline-hacked2 monkey-timeline-hacked3
        monkey1-timeline1
#       monkey1-timeline-objvar
#       monkey1-timeline-twomonkeys-objvar
#       monkey1-timeline-twomonkeys
#       monkey2-timeline2 monkey2-timeline22 monkey2-timeline23
        robotTests
#       roverTests # Failing; see below
#       roverCTTests # Failing; see below
#       merTests # Failing; see below
#       gnats-C3 # Failing; see below
#       gnats-NoBranchBug # Failing; see below
#       gnats-P4-C3 # Failing; see below
#       gnats-P4-C3eq # Failing; see below
        gnats-condasame
        gnats-rover-fixed
#       gnats-sum # Failing; see below
#       dnp-timeline
#       dnp-DNP2
#       dnp-allDSS
#       dnp-fourFreeObs
#       dnp-DNP3fourFreeObs
#       dnp-DNP3
#       dnp-fourFreeObsNotEmpty
#       dnp-freeObs
#       dnp-freeObsNoEmpty
#       dnp-tenFreeObs
#       dnp-threeFreeObs
#       dnp-twentyFreeObs
#       dnp-twoFreeObs
        ;

#
# EUROPA TESTS
#   Converted from NewPlan/ModuleTests/Parser, e.g.
#
ModuleObjects runEUROPAtest.cc : HSTS ;

rule RunEUROPATest {

 local target = $(1) ;
 local initialStates = $(2) ;
 local heur = $(3) ;
 local pid = $(4) ;
 local otherObjects = $(5) ;

 local model ;
 for model in $(initialStates) {
  local exe = $(model:S=) ;
  local hh = $(model:S=.hh) ;
  local cc = [ FGristFiles $(model:S=.cc) ] ;
  local xml = $(model:S=.xml) ;
  local o = $(cc:S=.o) ;
  local lib = $(model:S=) ;
  local options = " -i "$(xml) ;
  if $(heur) {
    options += " -h "$(heur) ;
  }
  if ($pid) {
    options += " -p "$(pid) ;
  }

  # create .hh, .cc, .o, and .xml for a .nddl
  Includes $(cc) : $(hh) ;
  NddlCompiler $(hh) $(cc) : $(model) ;
  ModuleObjects $(cc) : NDDL ;

  # create planner with linked model
  ModuleMain $(exe) : $(o) runEUROPAtest.o $(otherObjects) : HSTS ;
  RunModuleMain run-$(exe) : $(exe) : $(options) : : "run-$(exe).output" ;
  LocalDepends $(target) : run-$(exe) ;
 }
}

RunEUROPATest monkey-timeline : timeline0.nddl ;
RunEUROPATest monkey-timeline-hacked : timeline-hacked.nddl ;
RunEUROPATest monkey-timeline-hacked2 : timeline-hacked2.nddl ;
RunEUROPATest monkey-timeline-hacked3 : timeline-hacked3.nddl ;

# Failing; see GNATS 2759, 2760, and 2701.
RunEUROPATest monkey1-timeline1 : timeline1.nddl ;

# Failing: Utils/core/Id.hh:419: Error: Id<T>::convertable(org) is false
#   Gdb on Token says *this is a RuleInstance but T (of Id<T>) is class Token (!).
RunEUROPATest monkey1-timeline-objvar : timeline-objvar.nddl ;

# Failing: ConstraintEngine/core/ConstrainedVariable.cc:192: Error: internal_specifiedDomain().isMember(singletonValue) is false
#   Reported as GNATS 2760.
RunEUROPATest monkey1-timeline-twomonkeys-objvar : timeline-twomonkeys-objvar.nddl ;

# Failing: ConstraintEngine/core/ConstrainedVariable.cc:192: Error: internal_specifiedDomain().isMember(singletonValue) is false
#   Reported as GNATS 2760.
RunEUROPATest monkey1-timeline-twomonkeys : timeline-twomonkeys.nddl ;

# Failing
RunEUROPATest monkey2-timeline2 : timeline2.nddl ; 
RunEUROPATest monkey2-timeline22 : timeline22.nddl ;
RunEUROPATest monkey2-timeline23 : timeline23.nddl ;

RunEUROPATest robotTests : req1.nddl ;

# These fail; converter used explicit bounds on a temporal constraint, which the NDDL compiler does not support.
#   Reported in GNATS 2762.
# Also, the NDDL compiler printed the wrong file name for the error: rover.nddl rather than rover-test.nddl,
#     rover3.nddl rather than rover3-test.nddl, rover4.nddl rather than rover4-test.nddl, and
#     multrover.nddl rather than multrover-test.nddl.
#   Reported in GNATS 2761.
# RunEUROPATest roverTests : rover-test.nddl rover3-test.nddl rover4-test.nddl multrover-test.nddl ;

# These use constraint tokens, which Europa2 (PLASMA) does not support.
#   Verified as mentioned in PLASMA/MigrationNotes (entry 8 currently).
# RunEUROPATest roverCTTests : rover2-test.nddl rover2a-test.nddl rover2b-test.nddl ;

# Converter and/or NDDL compiler has bugs.  Reported as GNATS 2763.
# RunEUROPATest merTests : R1-files-p1.nddl R1-files-p2.nddl R1-files-p3.nddl R2-files-R21-Bill.nddl R2-files-R21-IDD1.nddl
#         R2-files-R21-IDD2.nddl R2-files-R21-IDD3.nddl R2-files-R21-PMA1.nddl R2-files-R21-PMA2.nddl
#         mer-1.nddl mer-bill-2.nddl mer-bill.nddl mer-idd1.nddl mer-idd2.nddl mer-idd3.nddl mer-pma-comm.nddl mer-pma1.nddl mer-pma2.nddl ;

# Fails Id::isValid() check, I believe as noted in GNATS 2757.
RunEUROPATest gnats-C3 : C3-init.nddl ;

# Fails; not sure how or why yet, but no error message
RunEUROPATest gnats-NoBranchBug : NoBranchBug-init.nddl ;

# These two take over an hour on Token for some reason and may be infinite loop or similar
RunEUROPATest gnats-P4-C3 : P4-C3-init.nddl ;
RunEUROPATest gnats-P4-C3eq : P4-C3eq-init.nddl ;

# Fails Id::isValid() check, I believe as noted in GNATS 2757.
RunEUROPATest gnats-SC : SC-init.nddl ;

RunEUROPATest gnats-condasame : condasame-init.nddl ;
RunEUROPATest gnats-rover-fixed : rover-fixed-init.nddl ;

# Fails Id::isValid() check, I believe as noted in GNATS 2757.
RunEUROPATest gnats-sum : sum-init.nddl ;

# DNP tests need the DNP specific constraints.
RunEUROPATest dnp-timeline : DNP.timeline.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-DNP2 : DNP2.timeline.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-allDSS : allDSS.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-fourFreeObs : fourFreeObs.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-DNP3fourFreeObs : DNP3.fourFreeObs.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-DNP3 : DNP3.timeline.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-fourFreeObsNotEmpty : fourFreeObs-initBufNotEmpty.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-freeObs : freeObs.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-freeObsNoEmpty : freeObs.noEmpty.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-tenFreeObs : tenFreeObs.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-threeFreeObs : threeFreeObs.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-twentyFreeObs : twentyFreeObs.nddl : : : DNPConstraints.o ;
RunEUROPATest dnp-twoFreeObs : twoFreeObs.nddl : : : DNPConstraints.o ;

# Example with converted heuristics and planId files.
# RunEUROPATest dnp3-fourFreeObs : dnp3-fourFreeObs-tx.nddl : dnp3.heuristics.xml : dnp3.heuristics.pid ;

} # PLASMA_READY
