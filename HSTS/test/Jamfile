SubDir PLASMA HSTS test ;

if ! $(PLASMA_READY) {

#
# Heuristics Tests
#

HSTS_Test_Files = [ FGristFiles AtSubgoalRule HSTSModuleTests DNPConstraints ] ;
ModuleObjects $(HSTS_Test_Files:S=.cc) : HSTS ;

CET_Files = <ConstraintEngine!test>ConstraintTesting ;

# ConstraintTesting.hh is in ConstraintEngine/test, not here.
# !!This doesn't work, however, so I've changed the source to '#include "test/ConstraintingTest.hh"' to see if that works.
# INCLUDES on module-tests.cc += [ FDirName $($(_top)) ConstraintEngine test ] ;

ModuleMain hsts-module-tests : $(HSTS_Test_Files:S=$(SUFOBJ)) $(CET_Files:S=$(SUFOBJ)) module-tests.cc : HSTS : CBPlanner ;
RunModuleMain run-hsts-module-tests : hsts-module-tests ;

# Commented out tests are failing for various reasons; see each test for more info.
LocalDepends tests : run-hsts-module-tests
        monkey-timeline monkey-timeline-hacked monkey-timeline-hacked2 monkey-timeline-hacked3
        monkey1-timeline1
#       monkey1-timeline-objvar
#       monkey1-timeline-twomonkeys-objvar
#       monkey1-timeline-twomonkeys
        monkey2-timeline2
        monkey2-timeline22
        monkey2-timeline23
        robotTests
        roverTest1
#       roverTest2
        roverTest3
        roverTest4
#       roverCTTests # Fails: uses NewPlan's constraint tokens, which Europa2 does not support.
#       merTest1
#       merTest2
#       merTest3
#       merTest4
        merTest5
#       merTest6
#       merTest7
        merTest8
        merTest9
#       merTest10
#       merTest11
#       merTest12
        merTest13
#       merTest14
#       merTest15
#       merTest16
        merTest17
        merTest18
        gnats-C3
        gnats-NoBranchBug
#       gnats-P4-C3
#       gnats-P4-C3eq
        gnats-SC
        gnats-condasame
        gnats-rover-fixed
        gnats-sum
#       dnp-timeline
#       dnp-DNP2
#       dnp-allDSS
#       dnp-fourFreeObs
#       dnp-DNP3fourFreeObs
#       dnp-DNP3
#       dnp-fourFreeObsNotEmpty
        dnp-freeObs
        dnp-freeObsNoEmpty
#       dnp-tenFreeObs
#       dnp-threeFreeObs
#       dnp-twentyFreeObs
#       dnp-twoFreeObs
        ;

#
# EUROPA TESTS
#   Converted from NewPlan/ModuleTests/Parser, e.g.
#
ModuleObjects runEUROPAtest.cc : HSTS ;

rule RunEUROPATest {

 local target = $(1) ;
 local initialStates = $(2) ;
 local heur = $(3) ;
 local pid = $(4) ;

 local model ;
 for model in $(initialStates) {
  local exe = $(model:S=) ;
  local hh = $(model:S=.hh) ;
  local cc = [ FGristFiles $(model:S=.cc) ] ;
  local other_cc = runEUROPAtest.cc DNPConstraints.cc ;
  local xml = $(model:S=.xml) ;
  local o = $(cc:S=$(SUFOBJ)) $(other_cc:S=$(SUFOBJ)) ;
  local lib = $(model:S=) ;
  local options = " -i "$(xml) ;
  if $(heur) {
    options += " -h "$(heur) ;
  }
  if ($pid) {
    options += " -p "$(pid) ;
  }

  # create .hh, .cc, .o, and .xml for a .nddl
  Includes $(cc) : $(hh) ;
  NddlCompiler $(hh) $(cc) : $(model) ;
  ModuleObjects $(cc) : NDDL ;

  # create planner with linked model
  ModuleMain $(exe) : $(o) : HSTS ;
  RunModuleMain run-$(exe) : $(exe) : $(options) : : "run-$(exe).output" ;
  LocalDepends $(target) : run-$(exe) ;
 }
}

RunEUROPATest monkey-timeline : timeline0.nddl ;
RunEUROPATest monkey-timeline-hacked : timeline-hacked.nddl ;
RunEUROPATest monkey-timeline-hacked2 : timeline-hacked2.nddl ;
RunEUROPATest monkey-timeline-hacked3 : timeline-hacked3.nddl ;
RunEUROPATest monkey1-timeline1 : timeline1.nddl ;

# Failing: Utils/core/Id.hh:423: Error: Id<T>::convertable(org) is false
#   Gdb on Token says *this is a RuleInstance but T (of Id<T>) is class Token (!).
#   Reported in GNATS 2798.
RunEUROPATest monkey1-timeline-objvar : timeline-objvar.nddl ;

# Failing: Utils/core/Id.hh:423: Error: Id<T>::convertable(org) is false
#   Reported in GNATS 2798.
RunEUROPATest monkey1-timeline-twomonkeys-objvar : timeline-twomonkeys-objvar.nddl ;

# Failing: Utils/core/Id.hh:423: Error: Id<T>::convertable(org) is false
#   Reported in GNATS 2798.
RunEUROPATest monkey1-timeline-twomonkeys : timeline-twomonkeys.nddl ;

# Failing: Utils/core/Utils.hh:134: Error: item.isValid() is false
#   Reported as GNATS 2768.
RunEUROPATest monkey2-timeline2 : timeline2.nddl ; 
RunEUROPATest monkey2-timeline22 : timeline22.nddl ;
RunEUROPATest monkey2-timeline23 : timeline23.nddl ;

RunEUROPATest robotTests : req1.nddl ;

RunEUROPATest roverTest1 : rover-test.nddl ;
RunEUROPATest roverTest3 : rover3-test.nddl ;
RunEUROPATest roverTest4 : rover4-test.nddl ;

# This now fails with:
#   ConstraintEngine/core/ConstraintLibrary.cc:34: Error: isRegistered(name) is false
#           Factory for constraint 'MultEqual' is not registered.
# ... while merging a token during planning.
RunEUROPATest roverTest2 : multrover-test.nddl ;

# These use constraint tokens, which Europa2 (PLASMA) does not support.
#   Verified as mentioned in PLASMA/MigrationNotes (entry 8 currently).
# RunEUROPATest roverCTTests : rover2-test.nddl rover2a-test.nddl rover2b-test.nddl ;

# Converter and/or NDDL compiler has bugs.  Reported as GNATS 2763.
RunEUROPATest merTest1 : R1-files-p1.nddl ;
RunEUROPATest merTest2 : R1-files-p2.nddl ;
RunEUROPATest merTest3 : R1-files-p3.nddl ;
RunEUROPATest merTest4 : R2-files-R21-Bill.nddl ;
RunEUROPATest merTest5 : R2-files-R21-IDD1.nddl ;
RunEUROPATest merTest6 : R2-files-R21-IDD2.nddl ;
RunEUROPATest merTest7 : R2-files-R21-IDD3.nddl ;
RunEUROPATest merTest8 : R2-files-R21-PMA1.nddl ;
RunEUROPATest merTest9 : R2-files-R21-PMA2.nddl ;
RunEUROPATest merTest10 : mer-1.nddl ;
RunEUROPATest merTest11 : mer-bill-2.nddl ;
RunEUROPATest merTest12 : mer-bill.nddl ;
RunEUROPATest merTest13 : mer-idd1.nddl ;
RunEUROPATest merTest14 : mer-idd2.nddl ;
RunEUROPATest merTest15 : mer-idd3.nddl ;
RunEUROPATest merTest16 : mer-pma-comm.nddl ;
RunEUROPATest merTest17 : mer-pma1.nddl ;
RunEUROPATest merTest18 : mer-pma2.nddl ;

# Fails Id::isValid() check, I believe as noted in GNATS 2757.
RunEUROPATest gnats-C3 : C3-init.nddl ;

# Fails with seg fault in std::list::insert().
#   Reported as GNATS 2770.
RunEUROPATest gnats-NoBranchBug : NoBranchBug-init.nddl ;

# These two take multiple hours without completing on Token for some reason and may be infinite loop or similar.
#   Reported as GNATS 2796.
RunEUROPATest gnats-P4-C3 : P4-C3-init.nddl ;
RunEUROPATest gnats-P4-C3eq : P4-C3eq-init.nddl ;

# Fails Id::isValid() check, I believe as noted in GNATS 2757.
RunEUROPATest gnats-SC : SC-init.nddl ;

RunEUROPATest gnats-condasame : condasame-init.nddl ;
RunEUROPATest gnats-rover-fixed : rover-fixed-init.nddl ;

# Fails Id::isValid() check, I believe as noted in GNATS 2757.
RunEUROPATest gnats-sum : sum-init.nddl ;

# DNP tests need the DNP specific constraints.
# These next two, at least, fail, perhaps due to lack of memory or seg fault or ... (no output)
RunEUROPATest dnp-timeline : DNP.timeline.nddl ;
RunEUROPATest dnp-DNP2 : DNP2.timeline.nddl ;
RunEUROPATest dnp-allDSS : allDSS.nddl ;
RunEUROPATest dnp-fourFreeObs : fourFreeObs.nddl ;
RunEUROPATest dnp-DNP3fourFreeObs : DNP3.fourFreeObs.nddl ;
RunEUROPATest dnp-DNP3 : DNP3.timeline.nddl ;
RunEUROPATest dnp-fourFreeObsNotEmpty : fourFreeObs-initBufNotEmpty.nddl ;
RunEUROPATest dnp-freeObs : freeObs.nddl ;
RunEUROPATest dnp-freeObsNoEmpty : freeObs.noEmpty.nddl ;
RunEUROPATest dnp-tenFreeObs : tenFreeObs.nddl ;
RunEUROPATest dnp-threeFreeObs : threeFreeObs.nddl ;
RunEUROPATest dnp-twentyFreeObs : twentyFreeObs.nddl ;
RunEUROPATest dnp-twoFreeObs : twoFreeObs.nddl ;

# Example with converted heuristics and planId files.
# RunEUROPATest dnp3-fourFreeObs : dnp3-fourFreeObs-tx.nddl : dnp3.heuristics.xml : dnp3.heuristics.pid ;

} # PLASMA_READY
